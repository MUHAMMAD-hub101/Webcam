<!DOCTYPE html>
<html>
<head>
    <title>Webcam to Server</title>
</head>
<body>
    <video id="webcam" autoplay playsinline style="width: 640px; height: 480px;"></video>
    <br>
    
    <button id="startBtn">Start Streaming</button>
    <button id="stopBtn" disabled>Stop Streaming</button>
    
    <div id="status">Ready</div>
    <div>FPS: <span id="fps">0</span></div>

    <script>
        const SERVER_URL = 'http://localhost:3000';  // ✅ Correct URL
        
        const video = document.getElementById('webcam');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusEl = document.getElementById('status');
        const fpsEl = document.getElementById('fps');
        
        let isStreaming = false;
        let stream = null;
        let canvas = null;
        let ctx = null;
        let frameCount = 0;
        let lastFpsTime = Date.now();
        let animationFrameId = null;
        
        // Initialize webcam
        async function initWebcam() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'user',
                        width: 640,
                        height: 480
                    },
                    audio: false
                });
                
                video.srcObject = stream;
                statusEl.textContent = 'Webcam ready';
                
                canvas = document.createElement('canvas');
                canvas.width = 640;
                canvas.height = 480;
                ctx = canvas.getContext('2d');
                
            } catch (error) {
                statusEl.textContent = 'Error: ' + error.message;
            }
        }
        
        // Capture and send frame
        function captureAndSendFrame() {
            if (!isStreaming || !ctx) return;
            
            // Draw video frame to canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convert to base64
            const imageData = canvas.toDataURL('image/jpeg', 0.5);
            const base64Data = imageData.replace(/^data:image\/jpeg;base64,/, '');
            
            // ✅ SEND TO SERVER CORRECTLY
            fetch(`${SERVER_URL}/frame`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ 
                    image: base64Data,
                    timestamp: Date.now()
                })
            })
            .then(response => {
                if (response.ok) {
                    console.log('Frame sent successfully');
                }
            })
            .catch(error => {
                console.log('Send error:', error);
            });
            
            // FPS counter
            frameCount++;
            const now = Date.now();
            if (now - lastFpsTime >= 1000) {
                fpsEl.textContent = frameCount;
                frameCount = 0;
                lastFpsTime = now;
            }
            
            // Next frame
            if (isStreaming) {
                animationFrameId = requestAnimationFrame(captureAndSendFrame);
            }
        }
        
        // Start streaming
        function startStreaming() {
            if (!stream) {
                statusEl.textContent = 'Webcam not ready';
                return;
            }
            
            isStreaming = true;
            statusEl.textContent = 'Streaming...';
            startBtn.disabled = true;
            stopBtn.disabled = false;
            
            captureAndSendFrame();
        }
        
        // Stop streaming
        function stopStreaming() {
            isStreaming = false;
            statusEl.textContent = 'Stopped';
            startBtn.disabled = false;
            stopBtn.disabled = true;
            
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
        }
        
        // Event listeners
        startBtn.addEventListener('click', startStreaming);
        stopBtn.addEventListener('click', stopStreaming);
        
        // Initialize
        window.addEventListener('load', initWebcam);
    </script>
</body>
</html>